src.digitaltwin.data_to_db
==========================

.. py:module:: src.digitaltwin.data_to_db

.. autoapi-nested-parse::

   This script fetches geospatial data from various providers using the 'geoapis' library and stores it in the database.
   It also saves user log information in the database.



Attributes
----------

.. autoapisummary::

   src.digitaltwin.data_to_db.log


Exceptions
----------

.. autoapisummary::

   src.digitaltwin.data_to_db.NoNonIntersectionError


Classes
-------

.. autoapisummary::

   src.digitaltwin.data_to_db.GeospatialLayers
   src.digitaltwin.data_to_db.UserLogInfo


Functions
---------

.. autoapisummary::

   src.digitaltwin.data_to_db.create_table
   src.digitaltwin.data_to_db.check_table_exists
   src.digitaltwin.data_to_db.execute_query
   src.digitaltwin.data_to_db.fetch_vector_data_using_geoapis
   src.digitaltwin.data_to_db.get_nz_geospatial_layers
   src.digitaltwin.data_to_db.get_non_nz_geospatial_layers
   src.digitaltwin.data_to_db.get_geospatial_layer_info
   src.digitaltwin.data_to_db.get_vector_data_id_not_in_db
   src.digitaltwin.data_to_db.nz_geospatial_layers_data_to_db
   src.digitaltwin.data_to_db.get_non_intersection_area_from_db
   src.digitaltwin.data_to_db.process_new_non_nz_geospatial_layers
   src.digitaltwin.data_to_db.process_existing_non_nz_geospatial_layers
   src.digitaltwin.data_to_db.non_nz_geospatial_layers_data_to_db
   src.digitaltwin.data_to_db.store_geospatial_layers_data_to_db
   src.digitaltwin.data_to_db.user_log_info_to_db


Module Contents
---------------

.. py:class:: GeospatialLayers

   Bases: :py:obj:`Base`


   Class representing the 'geospatial_layers' table.

   .. attribute:: __tablename__

      Name of the database table.

      :type: str

   .. attribute:: unique_id

      Unique identifier for each geospatial layer entry (primary key).

      :type: int

   .. attribute:: data_provider

      Name of the data provider.

      :type: str

   .. attribute:: layer_id

      Identifier for the layer.

      :type: int

   .. attribute:: table_name

      Name of the table containing the data.

      :type: str

   .. attribute:: unique_column_name

      Name of the unique column in the table.

      :type: Optional[str]

   .. attribute:: coverage_area

      Coverage area of the geospatial data, e.g. 'New Zealand'.

      :type: Optional[str]

   .. attribute:: url

      URL pointing to the geospatial layer.

      :type: str


   .. py:attribute:: __tablename__
      :value: 'geospatial_layers'



   .. py:attribute:: unique_id


   .. py:attribute:: data_provider


   .. py:attribute:: layer_id


   .. py:attribute:: table_name


   .. py:attribute:: unique_column_name


   .. py:attribute:: coverage_area


   .. py:attribute:: url


   .. py:attribute:: __table_args__


.. py:class:: UserLogInfo

   Bases: :py:obj:`Base`


   Class representing the 'user_log_information' table.

   .. attribute:: __tablename__

      Name of the database table.

      :type: str

   .. attribute:: unique_id

      Unique identifier for each log entry (primary key).

      :type: int

   .. attribute:: source_table_list

      A list of tables (geospatial layers) associated with the log entry.

      :type: Dict[str]

   .. attribute:: created_at

      Timestamp indicating when the log entry was created.

      :type: datetime

   .. attribute:: geometry

      Geometric representation of the catchment area coverage.

      :type: Polygon


   .. py:attribute:: __tablename__
      :value: 'user_log_information'



   .. py:attribute:: unique_id


   .. py:attribute:: source_table_list


   .. py:attribute:: created_at


   .. py:attribute:: geometry


.. py:function:: create_table(engine: sqlalchemy.engine.Engine, table: Base) -> None

   Create a table in the database if it doesn't already exist, using the provided engine.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param table: Class representing the table to create.
   :type table: Base

   :returns: This function does not return any value.
   :rtype: None


.. py:function:: check_table_exists(engine: sqlalchemy.engine.Engine, table_name: str, schema: str = 'public') -> bool

   Check if a table exists in the database.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param table_name: The name of the table to check for existence.
   :type table_name: str
   :param schema: The name of the schema where the table resides. Defaults to "public".
   :type schema: str = "public"

   :returns: True if the table exists, False otherwise.
   :rtype: bool


.. py:function:: execute_query(engine: sqlalchemy.engine.Engine, query) -> None

   Execute the given query on the provided engine using a session.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param query: The query to be executed.

   :returns: This function does not return any value.
   :rtype: None

   :raises Exception: If an error occurs during the execution of the query.


.. py:function:: fetch_vector_data_using_geoapis(data_provider: str, layer_id: int, crs: int = 2193, verbose: bool = False, bounding_polygon: Optional[geopandas.GeoDataFrame] = None) -> geopandas.GeoDataFrame

   Fetch vector data using 'geoapis' based on the specified data provider, layer ID, and other parameters.

   :param data_provider: The data provider to use. Supported values: "StatsNZ", "LINZ", "LRIS", "MFE".
   :type data_provider: str
   :param layer_id: The ID of the layer to fetch.
   :type layer_id: int
   :param crs: The coordinate reference system (CRS) code to use. Default is 2193.
   :type crs: int = 2193
   :param verbose: Whether to print messages. Default is False.
   :type verbose: bool = False
   :param bounding_polygon: Bounding polygon for data fetching. Default is all of New Zealand.
   :type bounding_polygon: Optional[gpd.GeoDataFrame] = None

   :returns: A GeoDataFrame containing the fetched vector data.
   :rtype: gpd.GeoDataFrame

   :raises ValueError: If an unsupported 'data_provider' value is provided.


.. py:data:: log

.. py:exception:: NoNonIntersectionError

   Bases: :py:obj:`Exception`


   Exception raised when no non-intersecting area is found.


.. py:function:: get_nz_geospatial_layers(engine: sqlalchemy.engine.Engine) -> pandas.DataFrame

   Retrieve geospatial layers from the database that have a coverage area of New Zealand.

   :param engine: The engine used to connect to the database.
   :type engine: Engine

   :returns: Data frame containing geospatial layers that have a coverage area of New Zealand.
   :rtype: pd.DataFrame


.. py:function:: get_non_nz_geospatial_layers(engine: sqlalchemy.engine.Engine) -> pandas.DataFrame

   Retrieve geospatial layers from the database that do not have a coverage area of New Zealand.

   :param engine: The engine used to connect to the database.
   :type engine: Engine

   :returns: Data frame containing geospatial layers that do not have a coverage area of New Zealand.
   :rtype: pd.DataFrame


.. py:function:: get_geospatial_layer_info(layer_row: pandas.Series) -> Tuple[str, int, str, str]

   Extracts geospatial layer information from a single layer entry.

   :param layer_row: A geospatial layer row that represents a single geospatial layer along with its associated information.
   :type layer_row: pd.Series

   :returns: A tuple containing the values for data_provider, layer_id, table_name, and unique_column_name.
   :rtype: Tuple[str, int, str, str]


.. py:function:: get_vector_data_id_not_in_db(engine: sqlalchemy.engine.Engine, vector_data: geopandas.GeoDataFrame, table_name: str, unique_column_name: str, area_of_interest: geopandas.GeoDataFrame) -> Set[int]

   Get the IDs from the fetched vector_data that are not present in the specified database table
   for the area of interest.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param vector_data: A GeoDataFrame containing the fetched vector data.
   :type vector_data: gpd.GeoDataFrame
   :param table_name: The name of the table in the database.
   :type table_name: str
   :param unique_column_name: The name of the unique column in the table.
   :type unique_column_name: str
   :param area_of_interest: A GeoDataFrame representing the area of interest.
   :type area_of_interest: gpd.GeoDataFrame

   :returns: The set of IDs from the fetched vector_data that are not present in the specified table in the database.
   :rtype: Set[int]


.. py:function:: nz_geospatial_layers_data_to_db(engine: sqlalchemy.engine.Engine, crs: int = 2193, verbose: bool = False) -> None

   Fetches New Zealand geospatial layers data using 'geoapis' and stores it into the database.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param crs: The coordinate reference system (CRS) code to use. Default is 2193.
   :type crs: int = 2193
   :param verbose: Whether to print messages. Default is False.
   :type verbose: bool = False

   :returns: This function does not return any value.
   :rtype: None


.. py:function:: get_non_intersection_area_from_db(engine: sqlalchemy.engine.Engine, catchment_area: geopandas.GeoDataFrame, table_name: str) -> geopandas.GeoDataFrame

   Get the non-intersecting area from the catchment area and user log information table in the database
   for the specified table.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param catchment_area: A GeoDataFrame representing the catchment area.
   :type catchment_area: gpd.GeoDataFrame
   :param table_name: The name of the table in the database.
   :type table_name: str

   :returns: The non-intersecting area, or the original catchment area if no intersections are found.
   :rtype: gpd.GeoDataFrame

   :raises NoNonIntersectionError: If the non-intersecting area is empty, it suggests that the catchment area is already fully covered.


.. py:function:: process_new_non_nz_geospatial_layers(engine: sqlalchemy.engine.Engine, data_provider: str, layer_id: int, table_name: str, area_of_interest: geopandas.GeoDataFrame, crs: int = 2193, verbose: bool = False) -> None

   Fetches new non-NZ geospatial layers data using 'geoapis' and stores it into the database.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param data_provider: The data provider of the geospatial layer.
   :type data_provider: str
   :param layer_id: The ID of the geospatial layer.
   :type layer_id: int
   :param table_name: The database table name of the geospatial layer.
   :type table_name: str
   :param area_of_interest: A GeoDataFrame representing the area of interest.
   :type area_of_interest: gpd.GeoDataFrame
   :param crs: The coordinate reference system (CRS) code to use. Default is 2193.
   :type crs: int = 2193
   :param verbose: Whether to print messages. Default is False.
   :type verbose: bool = False

   :returns: This function does not return any value.
   :rtype: None


.. py:function:: process_existing_non_nz_geospatial_layers(engine: sqlalchemy.engine.Engine, data_provider: str, layer_id: int, table_name: str, unique_column_name: str, area_of_interest: geopandas.GeoDataFrame, crs: int = 2193, verbose: bool = False) -> None

   Fetches existing non-NZ geospatial layers data using 'geoapis' and stores it into the database.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param data_provider: The data provider of the geospatial layer.
   :type data_provider: str
   :param layer_id: The ID of the geospatial layer.
   :type layer_id: int
   :param table_name: The database table name of the geospatial layer.
   :type table_name: str
   :param unique_column_name: The unique column name used for record identification in the database table.
   :type unique_column_name: str
   :param area_of_interest: A GeoDataFrame representing the area of interest.
   :type area_of_interest: gpd.GeoDataFrame
   :param crs: The coordinate reference system (CRS) code to use. Default is 2193.
   :type crs: int = 2193
   :param verbose: Whether to print messages. Default is False.
   :type verbose: bool = False

   :returns: This function does not return any value.
   :rtype: None


.. py:function:: non_nz_geospatial_layers_data_to_db(engine: sqlalchemy.engine.Engine, catchment_area: geopandas.GeoDataFrame, crs: int = 2193, verbose: bool = False) -> None

   Fetches non-NZ geospatial layers data using 'geoapis' and stores it into the database.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param catchment_area: A GeoDataFrame representing the catchment area.
   :type catchment_area: gpd.GeoDataFrame
   :param crs: The coordinate reference system (CRS) code to use. Default is 2193.
   :type crs: int = 2193
   :param verbose: Whether to print messages. Default is False.
   :type verbose: bool = False

   :returns: This function does not return any value.
   :rtype: None


.. py:function:: store_geospatial_layers_data_to_db(engine: sqlalchemy.engine.Engine, catchment_area: geopandas.GeoDataFrame, crs: int = 2193, verbose: bool = False) -> None

   Fetches geospatial layers data using 'geoapis' and stores it into the database.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param catchment_area: A GeoDataFrame representing the catchment area.
   :type catchment_area: gpd.GeoDataFrame
   :param crs: The coordinate reference system (CRS) code to use. Default is 2193.
   :type crs: int = 2193
   :param verbose: Whether to print messages. Default is False.
   :type verbose: bool = False

   :returns: This function does not return any value.
   :rtype: None


.. py:function:: user_log_info_to_db(engine: sqlalchemy.engine.Engine, catchment_area: geopandas.GeoDataFrame) -> None

   Store user log information to the database.

   :param engine: The engine used to connect to the database.
   :type engine: Engine
   :param catchment_area: A GeoDataFrame representing the catchment area.
   :type catchment_area: gpd.GeoDataFrame

   :returns: This function does not return any value.
   :rtype: None


